
@{
    ViewBag.Title = "EmployeeMonthlyReport";
    Layout = "~/Views/Shared/_adminLayout.cshtml";
}

<div class="row">
    <div class="table-responsive">
        <table id="dataTableExample" class="table-bordered table-striped">
            <thead>
                <tr>
                    <th class="text-center">SR</th>
                    <th>Employee Code</th>
                    <th>Name</th>
                    <th>Divison</th>
                    <th class="text-center">Download</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.MemberList != null)
                {
                    int count = 1;
                    foreach (var item in ViewBag.MemberList as List<RemoteSensingProject.Models.Admin.main.Employee_model>)
                    {
                        <tr>
                            <td class="text-start">@count</td>
                            <td>@item.EmployeeCode</td>

                            <td>@item.EmployeeName</td>
                            <td>@item.DevisionName</td>
                            <td class="text-center">
                                <a href="#" data-title="Report" class="monthlyReport" data-prjId="@item.Id">
                                    <i class="link-icon " data-feather="calendar" style="color:orangered"> </i>
                                </a>
                            </td>
                        </tr>
                        count++;
                    }
                }

            </tbody>
        </table>
    </div>

</div>

<div class="modal fade" id="viewMonthlyReportInternalPrj" tabindex="-1" aria-labelledby="viewMonthlyReportInternalPrjLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header d-flex">
                <h1 class="modal-title fs-5 text-success" id="viewMonthlyReportInternalPrjLabel">Monthly Report</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"  id="formToPrintMonthlyRprt">
                <div class="form-container">
                    <div class="row">
                        <div class="col-sm-6 mx-auto text-center">
                            <span>मासिक समीक्षा: रूप पत्र-2</span>
                            <p class="fw-bold" style="font-size: 15px;">शासन से गैर वेतन मद में प्राप्त धनराशि से संचालित योजना / कार्यक्रम की भौतिक उपलब्धियो का विवरण </p>
                        </div>
                    </div>
                    <input type="hidden" id="hiddenProjectId" />
                    <!-- Year and Month Filter -->
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <label for="filterYear">Year</label>
                            <select class="form-select" id="filterYear">
                                @for (int i = DateTime.Now.Year; i >= 2020; i--)
                                {
                                    <option value="@i" @(i == DateTime.Now.Year ? "selected" : "")>@i</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <label for="filterMonth">Month</label>
                            <select class="form-select" id="filterMonth">
                                <!-- Options will be added dynamically -->
                                @{
                                    DateTime start = new DateTime(DateTime.Now.Year, 1, 1); // January of current year
                                    int currentMonth = DateTime.Now.Month;

                                    for (int i = 1; i <= 12; i++)
                                    {
                                        <option value="@start.Month" selected="@(start.Month == currentMonth ? "selected" : null)">
                                            @start.ToString("MMMM")
                                        </option>
                                        ;

                                        start = start.AddMonths(1);
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div class="form-title">
                            भू-संसाधन प्रभाग
                        </div>
                        <div class="form-title">
                            माह: @DateTime.Now.ToString("MMMM"), @DateTime.Now.Year
                        </div>

                    </div>

                    <table class="table-bordered">
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 5%">क्र.सं.</th>
                                <th rowspan="2" style="width: 10%">मद / परियोजन का नाम</th>
                                <th rowspan="2" style="width: 10%">इकाई</th>
                                <th colspan="2" class="text-center" style="width: 30%">लक्ष्य</th>
                                <th colspan="2" class="text-center" style="width: 30%">उपलब्धि</th>
                                <th rowspan="2" style="width: 10%">प्रदेश सरकार के लाभाविंत होने वाले विभाग</th>
                                <th rowspan="2" style="width: 10%">अभ्युक्ति</th>
                            </tr>
                            <tr>
                                <th style="width:15%">वार्षिक</th>
                                <th style="width:15%">आलोच्य मासांत तक</th>
                                <th style="width:15%">आलोच्य माह में</th>
                                <th style="width:15%">आलोच्य मासांत तक क्रमिक</th>
                            </tr>
                            <tr>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                                <th>6</th>
                                <th>7</th>
                                <th>8</th>
                                <th>9</th>
                            </tr>
                        </thead>
                        <tbody id="internalProjectTbody">
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-primary" value="Download" id="printMonthlyRprt" />
            </div>
        </div>
    </div>
</div>

<script>

    function loadInternalProjectDetail() {
        debugger
        let prjId = $("#hiddenProjectId").val();
        let month = $("#filterMonth").val();
        let year = $("#filterYear").val();
        if (prjId != null && prjId > 0) {

            $.ajax({
                url: "/admin/EmployeeReportMon",
                type: "get",
                data: { id: prjId, month: month, year: year },
                success: function (res) {
                    if (res.status) {
                        $("#internalProjectTbody").empty();
                        let index = 1;
                        console.log('data: ',res)
                        $.each(res.data, function (i, d) {
                            $("#internalProjectTbody").append(
                                `
                            <tr>
                                <td>${index++}</td>
                                <td>${d.ProjectName}</td>
                                <td>${d.Unit}</td>
                                <td>${d.AnnualTarget}</td>
                                <td>${d.TargetUptoReviewMonth}</td>
                                <td>${d.AchievementDuringReviewMonth}</td>
                                <td>${d.CumulativeAchievement}</td>
                                <td>${d.BenefitingDepartments}</td>
                                <td>${d.Remarks}</td>
                            </tr>
                            `
                            )
                        })

                        $("#viewMonthlyReportInternalPrj").modal("show")
                    }
                },
                error: function () {
                    Swal.fire({
                        title: "Server issue !",
                        text: "Some issue occured. Please try after sometime !",
                        icon: "error",
                        didClose: () => {
                            location.reload(true)
                        }
                    })
                }
            });
        }
    }

    $(document).ready(function () {

        // 1. When project link is clicked
        $(".monthlyReport").on("click", function (e) {
            e.preventDefault();
            let prjId = $(this).data("prjid");
            $("#hiddenProjectId").val(prjId);
            loadInternalProjectDetail(); // load data for current month/year
        });

        // 2. When month or year changes
        $("#filterMonth, #filterYear").on("change", function () {
            if ($("#hiddenProjectId").val() > 0) {
                loadInternalProjectDetail(); // reload table with new month/year
            }
        });

    });

    $("#printMonthlyRprt").click(function () {

        Swal.fire({
            title: "Please wait !",
            text: "Processing your request....",
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        })
        var formContent = document.getElementById("formToPrintMonthlyRprt").outerHTML;

        var style = `
   <link href="${window.location.origin}/assets/css/ExternalPrjStyle.css" rel="stylesheet" type="text/css"/>
   <link href="${window.location.origin}/assets/css/style.css" rel="stylesheet" type="text/css"/>
   `;
        let htmlContentToPdf = `<html><head>${style}</head><body><div>${formContent}</div></body></html>`;

        fetch("/login/ExportHtmlToPdf", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ HtmlText: htmlContentToPdf }) // Ensure case matches C# model
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to generate PDF");
                }

                // Extract filename from Content-Disposition header
                const contentDisposition = response.headers.get("Content-Disposition");
                let fileName = "Generated.pdf"; // Default fallback filename

                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (match && match[1]) {
                        fileName = match[1];
                    }
                }

                return response.blob().then(blob => ({ blob, fileName }));
            })
            .then(({ blob, fileName }) => {
                Swal.fire({
                    title: "Successfully !",
                    text: "Reinbursement pdf generated successfully.",
                    icon: "success"
                })
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url); // Free up memory
            })
            .catch(error => {
                Swal.fire({
                    title: "Sorry !",
                    text: "Some issue occured while processing your request.",
                    icon: "error"
                })
                console.error("Error:", error)
            });

    })


    $("#filterMonth, #filterYear").on("change", function () {
        loadInternalProjectDetail();   // no args needed
    });
</script>