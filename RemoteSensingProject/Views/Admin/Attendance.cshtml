
@{
    ViewBag.Title = "Attendance";
    Layout = "~/Views/Shared/_adminLayout.cshtml";
}

<style>
    table.dataTable thead th, table.dataTable tfoot th {
        font-weight: bold;
        background: #029e9d;
        color: white;
        text-transform: none;
    }
</style>
<nav class="page-breadcrumb d-flex align-items-center justify-content-between">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">/Employee Registration</li>
    </ol>
    @*<button class="btn btn-primary" id="addEmployeeBtn" data-bs-toggle="modal" data-bs-target="#addslider"><i class="link-icon" data-feather="plus"></i> Add Employee</button>*@
</nav>


<div class="row mx-0">
    <div class="col-md-12 p-0 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="dataTableExample" class="table">
                        <thead>
                            <tr>
                                <th class="text-center">Sr. No.</th>
                                <th>EmployeeCode</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Division</th>
                                <th>Designation</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ViewData["EmployeeList"] != null)
                            {
                                var count = 1;
                                foreach (var item in ViewData["EmployeeList"] as List<RemoteSensingProject.Models.Admin.main.Employee_model>)
                                {
                                    <tr>
                                        <td class="text-start">@count</td>
                                        <td>@item.EmployeeCode</td>
                                        <td><a href="#" data-title="View Attendance" data-id="@item.Id" class="showEmployeeProfile" data-bs-toggle="modal" data-bs-target="#viewslider">@item.EmployeeName</a></td>
                                        <td>@item.EmployeeRole</td>
                                        <td>@item.DevisionName</td>
                                        <td>@item.DesignationName</td>
                                        <td>@item.CreationDate</td>
                                    </tr>
                                    count++;
                                }

                            }

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewslider" tabindex="-1" aria-labelledby="viewslider" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-body">
                <div class="card p-0">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h4 class="py-1" >Outsource List</h4>
                        <button type="button" class="btn btn-close" data-bs-dismiss="modal"><i class="fa-solid fa-square-xmark fa-2xl" style="color: #029e9d !important;"></i></button>
                    </div>
                    <div class="card-body mt-0">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr class="py-0" style="background: #029e9d; font-weight: bold;">
                                        <th class="text-center">Sr. No.</th>
                                        <th>Name</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                    </tr>
                                </thead>
                                <tbody id="outsourcelist">
                                </tbody>
                            </table>
                            <div class="text-end mt-3">
                                <button type="button" class="btn btn-sm btn-danger rounded-0" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Attendance List Modal -->
<div class="modal fade" id="ViewattendanceModal" tabindex="-1">
    <div class="modal-dialog modal-md modal-dialog-scrollable" style="margin-top:-1%">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                <h5 class="text-light">Attendance Sheet Of <span id="employeeNameDisplayatttend"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-4">
                        <select class="form-select form-select-sm" id="yearFilter">
                            <option value="">Select Year</option>
                            @for (int y = 2006; y <= DateTime.Now.Year; y++)
                            {
                                <option value="@y" @(y == DateTime.Now.Year ? "selected" : "")>@y</option>
                            }
                        </select>
                    </div>

                    <div class="col-sm-4">
                        <select class="form-select form-select-sm" id="monthFilter">
                            <option value="">Select Month</option>
                            @{
                                string[] months = new string[]
                                {
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
};

                                int currentMonth = DateTime.Now.Month;
                                int previousMonth = currentMonth == 1 ? 12 : currentMonth - 1;

                                for (int i = 1; i <= months.Length; i++)
                                {
                                    <option value="@i" @(i == previousMonth ? "selected" : "")>@months[i - 1]</option>
                                }
                            }
                        </select>
                    </div>


                    <div class="col-sm-4 text-end" style="font-size:12px !important;">
                        <div>Total Present : <span id="pres"></span></div>
                        <div>Total Absent : <span id="abs"></span></div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="attendancetable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th class="text-center">Attendance Status</th>
                                <th class="text-center">Remark</th>
                            </tr>
                        </thead>
                        <tbody id="attendancelist">
                        </tbody>
                    </table>
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-sm btn-danger rounded-0" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var pm;
        function convertDateFormat(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date)) return null;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            } catch (error) {
                return null;
            }
        }

        $(".showEmployeeProfile").on("click", function () {
            debugger
            Swal.fire({
                title: 'Please wait!', text: 'Processing your request', allowOutsideClick: false, allowEscapeKey: false, didOpen: () => { Swal.showLoading(); }
            });
            let id = $(this).data("id");
            pm = id;
            $.ajax({
                url: '/api/getOutsourceByPm'
                , type: 'GET', data: { projectManager: id },
                success: function (res) {
                    Swal.close();
                    console.log(res.data);
                    if (res.StatusCode === 200 && res.data != null) {
                        let rows = '';
                        $.each(res.data, function (index, item) {
                            rows += `
<tr>
    <td>${index + 1}</td>
    <td>
    <a href="#" data-empid="${item.EmpId}" data-title="View Attendance" class="viewattendance" >${item.EmpName}</a>
</td>
    <td>${item.present}</td>
    <td>${item.absent}</td>
</tr>`;
                        });
                        $('#outsourcelist').html(rows);
                    } else {
                        $('#outsourcelist').html('<tr><td colspan="4">No data found</td></tr>');
                    }

                },
                error: function () {
                    Swal.fire({
                        title: 'Error', text: 'Failed to fetch data...', icon: 'error', confirmButtonText: 'OK'
                    })
                }
            })
        });
        $(document).on("click", ".viewattendance", function () {
            debugger;

            Swal.fire({
                title: "Please Wait!",
                text: "Processing your request",
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => { Swal.showLoading(); }
            });
            debugger
            let id = $(this).data("empid");
            let today = new Date();
            console.log(today.getFullYear())
            console.log(today.getMonth() - 1)
            $("#yearFilter").val(today.getFullYear());
            $("#monthFilter").val(today.getMonth());

            $.ajax({
                url: '/api/getAttendanceListByEmp',
                type: 'get',
                data: { projectManager: pm, EmpId: id },
                success: function (res) {
                    Swal.close();
                    if (!res.status || res.data.length === 0) {
                        Swal.fire({
                            title: "No Data Found",
                            text: "No attendance records found for this employee.",
                            icon: "info"
                        });
                        return;
                    }
                    function convertDateFormat(dateString) {
                        const date = new Date(dateString);
                        return date.toLocaleDateString(); // e.g., 3/2/2025 (based on locale)
                    }
                    console.log('Attendance List', res);
                    $("#employeeNameDisplayatttend").text(res.data[0].EmpName);
                    $("#employeeNameDisplayatttend").attr('data-id', res.data[0].EmpId);
                    $("#pres").text(res.data[0].present)
                    $("#abs").text(res.data[0].absent)
                    $("#attendancelist").empty();
                    $.each(res.data, function (index, item) {
                        console.log(item.attendanceDate)
                        var row = $('<tr>');
                        row.append('<td>' + convertDateFormat(item.attendanceDate) + '</td>');
                        row.append('<td class="text-center">' + item.attendanceStatus + '</td>');
                        console.log('Status', item.projectManagerAppr);
                        if (item.projectManagerAppr) {
                            row.append('<td class="text-center"><a href="#" data-title="' + item.remark + '"><i class="fa-solid fa-check-double"></i></a></td>');
                        } else {
                            row.append('<td class="text-center"><a href="#" data-title="' + item.remark + '"><i class="fa-solid fa-ban"></i></a></td>');
                        }

                        $("#attendancelist").append(row);
                    });

                    $("#ViewattendanceModal").modal("show");
                },
                error: function (xhr) {
                    Swal.fire({
                        title: "Error",
                        text: 'Failed to fetch Data',
                        icon: 'error'
                    });
                }
            });
        });

    
        $("#attendancetable").DataTable()

        $("#monthFilter").on("change", function () {
            debugger
            Swal.fire({
                title: 'Please Wait!',
                text: 'Processing your request...',
                allowEscapeKey: false,
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            let id = $("#employeeNameDisplayatttend").attr('data-id');
            let month = $(this).val();
            let year = $("#yearFilter").val();
            console.log('pmm', pm);
            $.ajax({
                url: '/api/MonthFilter',
                type: 'get',
                data: { year: year, month: month, projectManager:pm, EmpId: id },
                success: function (res) {
                    Swal.close();
                    if (!res.data || res.data.length === 0) {
                        Swal.fire({
                            title: "No Data Found",
                            text: "No attendance records found for this employee of this month.",
                            icon: "info",
                            didClose: () => {
                                $("#attendancelist").empty();
                                $("#pres").text('0')
                                $("#abs").text(0)
                            }
                        });
                        return;
                    }
                    function convertDateFormat(dateString) {
                        const date = new Date(dateString);
                        return date.toLocaleDateString(); // e.g., 3/2/2025 (based on locale)
                    }
                    console.log('Attendance List', res.data);
                    $("#pres").text(res.data[0].present)
                    $("#abs").text(res.data[0].absent)
                    $("#attendancelist").empty();
                    $.each(res.data, function (index, item) {
                        var row = $('<tr>');
                        row.append('<td>' + convertDateFormat(item.attendanceDate) + '</td>');
                        row.append('<td class="text-center">' + item.attendanceStatus + '</td>');

                        if (item.projectManagerAppr) {
                            row.append('<td class="text-center"><a href="#" data-title="' + item.remark + '"><i class="fa-solid fa-check-double"></i></a></td>');
                        } else {
                            row.append('<td class="text-center"><a href="#" data-title="' + item.remark + '"><i class="fa-solid fa-ban text-danger"></i></a></td>');
                        }

                        $("#attendancelist").append(row);
                    });
                },
                error: function (xhr, error, message) {
                    Swal.fire({
                        title: 'Error',
                        text: 'Failed to fetch data. Please Try Again!',
                        icon: 'error'
                    });
                    console.log(xhr)
                    console.log(message)
                    console.log(error)
                }
            });
        });
    })
</script>