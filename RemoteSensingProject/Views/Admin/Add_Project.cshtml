
@{
    ViewBag.Title = "Add_Project";
    Layout = "~/Views/Shared/_adminLayout.cshtml";
}


<style>
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #444;
        line-height: 13px;
    }
    .select2-selection {
        height: 34px !important;
        border-radius: 10px !important;
    }
    .select2-selection__rendered{
        line-height:17px !important;
    }
    .select2-selection__arrow{
        height:32px !important;
    }
</style>
    <nav class="page-breadcrumb d-flex align-items-center justify-content-between">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item active" aria-current="page">Add Project</li>
        </ol>
        <a href="/admin/Project_List" class="btn btn-primary"><i class="link-icon" data-feather="arrow-left"></i> Back To List</a>
    </nav>
    <div class="row mx-0">
        <div class="col-md-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <form class="forms-sample" id="createProjectForm" >
                        <div class="row">
                            <div class="col-lg-4 mb-3">
                                <label for="upload" class="form-label">Title</label>
                                <input type="text" name="pm.pm.ProjectTitle" required class="form-control form-control-sm" id="daynight" placeholder="Enter Project Title">
                            </div>
                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label">Assign Date</label>
                                <div class="input-group date datepicker datePickerExample">
                                    <input type="text" required class="form-control form-control-sm" name="pm.pm.AssignDate">
                                    <span class="input-group-text input-group-addon"><i data-feather="calendar"></i></span>
                                </div>
                            </div>
                            <div class="col-lg-4 mb-3">
                                <label for="subtitle" class="form-label">Start Date</label>
                                <div class="input-group date datepicker datePickerExample">
                                    <input type="text" required class="form-control form-control-sm" name="pm.pm.StartDate">
                                    <span class="input-group-text input-group-addon"><i data-feather="calendar"></i></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label">Completion Date</label>
                                <div class="input-group date datepicker datePickerExample">
                                    <input type="text" required class="form-control form-control-sm" name="pm.pm.CompletionDate">
                                    <span class="input-group-text input-group-addon"><i data-feather="calendar"></i></span>
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label mb-1">Project Manager</label>
                                <select class="form-select form-select-sm" required name="pm.pm.ProjectManager">
                                    <option value="">Select an Option</option>
                                    @foreach (var item in ViewBag.projectManager as List<RemoteSensingProject.Models.Admin.main.Employee_model>)
                                    {
                                        <option value="@item.Id">@item.EmployeeName (@item.EmployeeCode)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label mb-1">Sub-Ordinate</label>
                                <select class="form-select form-select-sm" required name="pm.pm.SubOrdinate" multiple>
                                    <option value="">Select an Option</option>
                                    @foreach (var item in ViewBag.subOrdinateList as List<RemoteSensingProject.Models.Admin.main.Employee_model>)
                                    {
                                        <option value="@item.Id">@item.EmployeeName (@item.EmployeeCode)</option>
                                    }
                                </select>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <label for="letterNumber" class="form-label">Letter Number</label>
                                <div class="input-group">
                                    <input type="text" required class="form-control form-control-sm" name="pm.pm.letterNo" id="letterNumber" placeholder="Enter Letter Number">
                                </div>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <div class="d-flex justify-content-between">
                                    <label for="title" class="form-label">Budget</label><label class="form-label" id="addBudgetItem" data-count="0"> <a href="#"><i class="fa-solid fa-circle-plus"></i> Add Budget Heads</a></label>
                                </div>
                                <input type="text" class="form-control form-control-sm" required name="pm.pm.ProjectBudget" id="budgetAmount" placeholder="Enter Project Budget">
                                <span id="budgetValidate" class="text-danger"></span>
                            </div>

                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label">Project Document</label>
                                <input type="file" class="form-control form-control-sm" required name="" id="projectDocumentFile">
                            </div>
                        </div>
                        <div class="row">
                            
                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label">Project Type</label>
                                <br />
                                <label for="projectType" class="form-label">
                                    <input type="radio" name="pm.pm.ProjectType" required class="form-check-input" value="Internal" checked /><span>Internal</span>
                                </label>
                                <label for="stage" class="form-label ms-2">
                                    <input type="radio" name="pm.pm.ProjectType" required class="form-check-input" value="External" /> <span>External</span>
                                </label>
                            </div>


                            <div class="col-lg-4 mb-3">
                                <label for="title" class="form-label w-100">Stage</label>
                                <label for="stage" class="form-label">
                                    <input type="radio" name="pm.pm.ProjectStage" required class="form-check-input" value="true" /> <span>Yes</span>
                                </label>
                                <label for="stage" class="form-label ms-2">
                                    <input type="radio" name="pm.pm.ProjectStage" required class="form-check-input" value="false" checked /><span>No</span>
                                </label>


                            </div>
                        </div>
                        <div id="budgetContainerBox" style="display:none;">
                            <fieldset>
                                <legend style="font-size:15px;"> <label class="form-label my-2 fw-bolder"><a href="#">Project Budget Detail</a></label></legend>


                                <div class="row budgetList">
                                    <div class="col-lg-5 mb-3">
                                        <label for="title" class="form-label">Heads</label>
                                        <input type="text"  class="form-control form-control-sm"  name="pm.budgets[0].ProjectHeads" id="" placeholder="Enter Key Point">
                                    </div>
                                    <div class="col-lg-5 mb-3">
                                        <label for="title" class="form-label">Amount</label>
                                        <input type="number" class="form-control form-control-s amnt" name="pm.budgets[0].ProjectAmount" placeholder="Enter amount...">
                                        <span id="_person" class="ms-2 text-danger"></span>
                                    </div>
                                </div>
                                <div class="row" id="miscList">
                                    <div class="col-lg-5 mb-3">
                                        <label for="title" class="form-label">
                                            Miscellaneous
                                        </label>
                                        <input type="text" class="form-control form-control-sm" name="pm.budgets[1].ProjectHeads" readonly id="" value="Miscellaneous" placeholder="Enter Key Point">
                                    </div>
                                    <div class="col-lg-5 mb-3">
                                        <label for="misAmount" class="form-label">Amount</label>
                                        <input type="number" readonly class="form-control form-control-sm" id="misAmount" name="pm.budgets[1].ProjectAmount" placeholder="Enter amount">
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div id="projectTypeDetailContainer" style="display:none;">
                            <fieldset>
                                <legend style="font-size:15px;">  <label class="form-label my-2 fw-bolder"><a href="#">External Project Detail</a></label></legend>

                               
                                <div class="row stageListItem">
                                    <div class="col-lg-4 mb-3">
                                        <label for="title" class="form-label">Department Name</label>
                                        <input type="text" class="form-control form-control-sm" id="venue" placeholder="Enter Key Point">
                                    </div>
                                    <div class="col-lg-4 mb-3">
                                        <label for="title" class="form-label">Contact Person</label>
                                        <input type="text" class="form-control form-control-sm" id="person" placeholder="Enter Contact Person Name">
                                    </div>
                                    <div class="col-lg-4 mb-3">
                                        <label for="title" class="form-label">Address</label>
                                        <input type="text" class="form-control form-control-sm" id="person" placeholder="Enter address">
                                    </div>

                                </div>
                                </fieldset>
                        </div>
                        <div id="stageItemContainer" style="display:none;">
                            <fieldset>
                                <legend style="font-size:15px;">
                                    <div class="d-flex justify-content-between">
                                        <label class="form-label my-2 fw-bolder"><a href="#">Project Stage Detail</a></label>
                                        <label class="form-label" id="addStageIcon" data-count="0 "> <a href="#"><i class="link-icon" data-feather="plus"></i> Add Stage</a> <sup style="font-size:10px; color:red;">(* Max 10 stage allowed)</sup></label>
                                    </div>
                                </legend>
                                
                                </fieldset>
                        </div>
                        <div class="row">
                            <div class="col-lg-12 mb-3">
                                <label for="description" class="form-label"> Description</label>
<textarea class="form-control form-control-sm" name="pm.pm.ProjectDescription" id="tinymceExample" rows="10" placeholder="Project Description"></textarea>
                            </div>
                            <div class="text-center">
                                <button type="submit" id="addbtn" class="btn btn-primary">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="~/Scripts/jquery-3.7.1.js"></script>
    <script>
    $(document).ready(function(){
        $("select").select2({
            placeholder: "Select an option",
        });

    })
    $(document).ready(function () {

        $("input[name='pm.pm.ProjectStage']").click(function () {
            if ($(this).val() === "true") {
                $("#stageItemContainer").show();
                $("#addStageIcon").show().click();
            } else {
                $("#stageItemContainer").hide();
                $("#addStageIcon").hide();
                $("#stageItemContainer .stageListItem").remove();
                $("#addStageIcon").attr("data-count", 1);
            }
        });


        $("#addStageIcon").click(function () {
            let count = parseInt($(this).attr("data-count"));
            if (count < 10) {
                let newElement = `
                <div class="row stageListItem">
                    <div class="col-lg-4 mb-3">
                        <label for="venue" class="form-label">Key Point</label>
                        <input type="text" class="form-control form-control-sm" name="pm.stages[${count}].KeyPoint" placeholder="Enter Key Point">
                    </div>
                    <div class="col-lg-4 mb-3">
                        <label for="person" class="form-label">Pdf Upload</label>
                        <input type="file" class="form-control form-control-sm stagesImages" name="pm.stages[${count}].Stage_Document"/>
                    </div>
                    <div class="col-lg-3 mb-3">
                        <label for="date" class="form-label">Complete Date</label>
                        <input type="date" class="form-control form-control-sm" name="pm.stages[${count}].CompletionDate">
                    </div>
                    <div class="col-lg-1 text-center mb-3" style="line-height:6;">
                        <a href="#" class="deleteCurrntRow">
                            <i class="fa-solid fa-trash text-danger fs-4" style="cursor: pointer;"></i>
                        </a>
                    </div>
                </div>`;
                $("#stageItemContainer").append(newElement);
                count++;
                $(this).attr("data-count", count);
            }
        });


        $("#stageItemContainer").on("click", ".deleteCurrntRow", function (e) {
            e.preventDefault();
            let i = $("#stageItemContainer #addStageIcon").attr("data-count");
            if (i > 0)
                i--;
            $("#stageItemContainer #addStageIcon").attr("data-count", i);
            $(this).closest(".row.stageListItem").remove();
        });


        $("input[name='pm.pm.ProjectType']").click(function () {
            if ($(this).val() === "External") {
                $("#projectTypeDetailContainer").show();
            } else {
                $("#projectTypeDetailContainer").hide();
            }
        });
        //managing budget section
        //$("#addBudgetItem").click(function () {
        //    debugger
        //    let budgetAmt = parseInt($("#budgetAmount").val())
        //    let ammt = parseInt($('#budgetContainerBox').find('.amnt').val())
        //    if ($("#budgetContainerBox").find('.amnt').empty()) {
        //        $("#misAmount").val(budgetAmt)
        //    }
        //    else {
        //        $('#misAmount').val(budgetAmt - parseInt($('#budgetContainerBox').find('.amnt').val()));
        //    }
        //    if (budgetAmt != null && budgetAmt > 0) {
        //        let count = parseInt($(this).attr("data-count"));
        //        $("#budgetContainerBox").show();
        //        if (count > 0) {
        //            let ele = `<div class="row budgetList">
        //                <div class="col-lg-5 mb-3">
        //                    <label for="title" class="form-label">Heads</label>
        //                    <input type="text" class="form-control form-control-sm" name="pm.budgets[${count + 1}].ProjectHeads" id="venue" placeholder="Enter Key Point">
        //                </div>
        //                <div class="col-lg-5 mb-3">
        //                    <label for="title" class="form-label">Amount</label>
        //                    <input type="number" class="form-control form-control-sm amnt"  name="pm.budgets[${count + 1}].ProjectAmount" placeholder="Enter amount">
        //                </div>
        //                <div class="col-lg-2 text-center mb-3" style="line-height:6;">
        //                    <a href="#" class="deleteCurrntRow">
        //                        <i class="fa-solid fa-trash text-danger fs-4" style="cursor: pointer;"></i>
        //                    </a>
        //                </div>

        //            </div>`;
        //            $("#miscList").before(ele);
        //        }
        //        count++;
        //        $(this).attr("data-count", count)
        //    }
        //    else {
        //        Swal.fire("Sorry !", "Budget amount is invalid", "warning")
        //    }
        //});
        //$("#budgetContainerBox").on("click", ".deleteCurrntRow", function (e) {
        //    e.preventDefault();
        //    let i = $("#budgetContainerBox #addBudgetItem").attr("data-count");
        //    if (i > 0)
        //        i--;
        //    $("#budgetContainerBox #addBudgetItem").attr("data-count", i);
        //    $(this).closest(".row.budgetList").remove();
        //});
    });

        $(document).ready(function () {

            // 🔹 Add Budget Head
            $("#addBudgetItem").click(function (e) {
                e.preventDefault();

                let budgetAmt = parseFloat($("#budgetAmount").val());

                if (isNaN(budgetAmt) || budgetAmt <= 0) {
                    Swal.fire("Sorry!", "Please enter a valid Project Budget first.", "warning");
                    return;
                }

                $("#budgetContainerBox").show();

                let count = parseInt($(this).attr("data-count")) || 0;

                // ✅ Pehli baar click par sirf ek hi row add ho
                // (pehle se koi head nahi hona chahiye)
                if (count === 0 && $(".budgetList").length > 1) {
                    // Already initial head hai, to new na banao
                    return;
                }

                // ✅ Dynamic new row template
                let ele = `
                    <div class="row budgetList">
                        <div class="col-lg-5 mb-3">
                            <label for="title" class="form-label">Heads</label>
                            <input type="text" class="form-control form-control-sm" name="pm.budgets[${count + 1}].ProjectHeads" placeholder="Enter Key Point">
                        </div>
                        <div class="col-lg-5 mb-3">
                            <label for="title" class="form-label">Amount</label>
                            <input type="number" class="form-control form-control-sm amnt" name="pm.budgets[${count + 1}].ProjectAmount" placeholder="Enter amount">
                        </div>
                        <div class="col-lg-2 text-center mb-3" style="line-height:6;">
                            <a href="#" class="deleteCurrntRow">
                                <i class="fa-solid fa-trash text-danger fs-4" style="cursor: pointer;"></i>
                            </a>
                        </div>
                    </div>`;

                // ✅ Sirf tab add kare jab ek extra row chahiye (avoid duplicate)
                if (count > 0 || $(".budgetList").length === 0) {
                    $("#miscList").before(ele);
                }

                $(this).attr("data-count", count + 1);

                updateMiscAmount();
            });

            // 🔹 Delete a head
            $("#budgetContainerBox").on("click", ".deleteCurrntRow", function (e) {
                e.preventDefault();
                $(this).closest(".budgetList").remove();
                updateMiscAmount();
            });

            // 🔹 When budget or head amount changes
            $(document).on("input", "#budgetAmount, .amnt", function () {
                updateMiscAmount($(this)); // Pass current field for reset if exceeded
            });

            // 🔹 Function to recalc remaining amount (Miscellaneous)
            function updateMiscAmount(changedInput = null) {
                let budgetAmt = parseFloat($("#budgetAmount").val()) || 0;
                let totalHeads = 0;

                $(".amnt").each(function () {
                    let val = parseFloat($(this).val());
                    if (!isNaN(val)) totalHeads += val;
                });

                // ✅ Check for exceed
                if (totalHeads > budgetAmt) {
                    Swal.fire("Warning!", "Total of all heads cannot exceed Project Budget!", "error");

                    // 🧹 Clear the field that caused exceed
                    if (changedInput) {
                        $(changedInput).val('');
                    }

                    // Recalculate after clearing
                    totalHeads = 0;
                    $(".amnt").each(function () {
                        let val = parseFloat($(this).val());
                        if (!isNaN(val)) totalHeads += val;
                    });
                }

                let remaining = budgetAmt - totalHeads;
                if (remaining < 0) remaining = 0;

                $("#misAmount").val(remaining);
            }
        });


</script>
<script>
    $(document).ready(function () {
        $("#budgetAmount").on("keyup", function(){
            $("#misAmount").val($(this).val())
        })
        $("#budgetContainerBox").find(".amnt").on("keyup", function () {
            debugger
            let amm = parseInt($("#budgetAmount").val());
            let am = parseInt($(this).val());
            if (am > amm) {
                $("#_person").text("Amount is not more than Budget Amount");
                $("#misAmount").val(0);
            }
            else if (am < amm) {
                $("#_person").text("");
                $("#misAmount").val(amm - am);
            }
            else if($(this).empty()) {
                $("#_person").text("");
                $("#misAmount").val(amm);
            }
            
        });
    });
</script>

<script>
    $(document).ready(function () {
        $("#createProjectForm").on("submit", function (e) {
            e.preventDefault();

            Swal.fire({
                title: "Please wait !",
                text: "Processing your request ....",
                timer: 100000,
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            let formData = new FormData();
            let arrData = $(this).serializeArray();

            // Loop through the serialized form data and append it to FormData
            arrData.forEach(function (d) {
                // Check if the key already exists in the formData
                if (!formData.has(d.name) && d.value.trim() !== "") {
                    formData.append(d.name, d.value);
                } else {
                    console.log(`Duplicate or empty key skipped: ${d.name}`);
                }
            });
            //let arrData = $(this).serializeArray();

            //// Add regular form data to formData object
            //arrData.forEach(function (d) {
            //    formData.append(d.name, d.value); 
            //});

            // Check if the project document file exists and append if not already added
            let file = $("#projectDocumentFile")[0].files[0];
            if (file) {
                // Avoid adding the same file multiple times
                if (!formData.has("pm.pm.projectDocument")) {
                    formData.append("pm.pm.projectDocument", file);
                }
            }

            // Loop through stages images and add them
            $.each($(".stagesImages"), function (i, d) {
                file = $(d)[0].files[0];
                if (file) {
                    let stageKey = `pm.stages[${i}].Stage_Document`;

                    // Avoid adding the same stage document multiple times
                    if (!formData.has(stageKey)) {
                        formData.append(stageKey, file);
                    }
                }
            });
            // Send the data via AJAX
            $.ajax({
                url: "/admin/InsertProject",
                type: "post",
                processData: false,
                contentType: false,
                data: formData,
                success: function (res) {
                    if (res.status) {
                        Swal.fire({
                            title: "Successfully !",
                            text: "Project created successfully !",
                            icon: "success",
                            didClose: () => {
                                location.reload(true);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: "Sorry !",
                            text: "Some issue occurred while processing your request ! Please try after sometime.",
                            icon: "warning"
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Error Details:");
                    console.log("XHR Object: ", xhr);
                    console.log("Status: ", status);
                    console.log("Error Message: ", error);
                    console.log("Response Text: ", xhr.responseText);
                    console.log("HTTP Status Code: ", xhr.status);
                    Swal.fire({
                        title: "Server issue !",
                        text: "Server is busy ! Try after sometime.",
                        icon: "error"
                    });
                }
            });
        });
    });
</script>